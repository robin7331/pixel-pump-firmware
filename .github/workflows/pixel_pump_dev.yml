name: Pixel Pump Dev

on:
  push:
    branches:
      - dev

jobs:
  dev-build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0
    - uses: actions/checkout@v2
      with:
        repository: micropython/micropython
        ref: '294baf52b346e400e2255c6c1e82af5b978b18f7' # v1.20 tag
        path: "./micropython"
    - name: Update apt-get
      run: sudo apt-get update
    - name: Install packages
      run: sudo apt-get install gcc-arm-none-eabi libnewlib-arm-none-eabi build-essential cmake git python3 -y
    - name: Apply HID fix
      run: |
        cd $GITHUB_WORKSPACE/micropython/
        git am $GITHUB_WORKSPACE/drivers/rp2_hid/0001-shared-tinyusb-Add-USB-HID-support.patch
    - name: Apply USB strings and enable HID fix
      run: |
        cd $GITHUB_WORKSPACE/micropython/
        git am $GITHUB_WORKSPACE/drivers/rp2_hid/0001-ports-rp2-boards-PICO-Use-Pixel-Pump-USB-strings-and.patch
    - name: Build blank MicroPython firmware (without Pixel Pump files)
      run: |
        cd $GITHUB_WORKSPACE/micropython/
        make -C mpy-cross
        git submodule update --init lib/pico-sdk lib/tinyusb
        make -C ports/rp2 BOARD=PICO
        mv $GITHUB_WORKSPACE/micropython/ports/rp2/build-PICO/firmware.uf2 $GITHUB_WORKSPACE/micropython/ports/rp2/build-PICO/firmware-blank.uf2
    - name: Generate Version File
      run: |
        python3 $GITHUB_WORKSPACE/tools/generateVersionFile.py --output $GITHUB_WORKSPACE/src/version.py --repo $GITHUB_WORKSPACE
    - name: Copy Pixel Pump firmware to MicroPython
      run: |
        cp -a $GITHUB_WORKSPACE/src/. $GITHUB_WORKSPACE/micropython/ports/rp2/modules/
    - name: Build Pixel Pump Firmware
      run: |
        cd $GITHUB_WORKSPACE/micropython/
        make -C ports/rp2 BOARD=PICO
    - uses: marvinpinto/action-automatic-releases@latest
      name: Release
      with:
        repo_token: "${{ secrets.GITHUB_TOKEN }}"
        prerelease: true
        draft: true
        title: "Pixel Pump Dev Build"
        automatic_release_tag: latest
        files: |
          micropython/ports/rp2/build-PICO/firmware.uf2
          micropython/ports/rp2/build-PICO/firmware-blank.uf2



